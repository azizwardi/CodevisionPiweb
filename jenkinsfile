pipeline {
    agent any

    environment {
        // Ajouter le chemin de node_modules/.bin au PATH
        PATH = "${WORKSPACE}/Backend/node_modules/.bin:${env.PATH}"
    }

    stages {
        // Ã‰tape 1 : Installation des dÃ©pendances
        stage('Install Dependencies') {
            steps {
                dir('Backend') {
                    sh 'npm install'
                }
            }
        }

        // Ã‰tape 2 : VÃ©rification et correction des permissions de nodemon
        stage('Fix Nodemon Permissions') {
            steps {
                dir('Backend') {
                   sh 'chmod +x node_modules/.bin/nodemon'  // Nodemon
                   sh 'chmod +x node_modules/.bin/webpack' // Webpack
                }
            }
        }

        // Ã‰tape 3 : Tests unitaires (simulÃ©s ici)
        stage('Unit Test') {
            steps {
                dir('Backend') {
                    script {
                        sh 'echo "No tests specified"'
                    }
                }
            }
        }

        // Ã‰tape 4 : Analyse SonarQube
        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'scanner'
                    withSonarQubeEnv('scanner') { // Remplacez 'scanner' par le nom de votre configuration SonarQube dans Jenkins
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }

        // Ã‰tape 5 : DÃ©marrer le serveur avec Nodemon (mode dev)
        stage('Start Dev Server') {
            steps {
                dir('Backend') {
                    script {
                        sh 'npm run build-dev' // DÃ©marrer le serveur en mode dÃ©veloppement
                    }
                }
            }
        }

        // ðŸš€ **Ã‰tape 6 : Build des images Docker**
        stage('Building images (node and mongo)') {
            steps {
                script {
                    sh 'docker-compose build'
                }
            }
        }
    } // âœ… Fin du bloc `stages {}`

    // Gestion des erreurs
    post {
        failure {
            echo 'Pipeline has failed. Check the logs for more details.'
        }
        success {
            echo 'Pipeline succeeded!'
        }
    }
}
