pipeline {
    agent any

    environment {
        // Ajouter le chemin de node_modules/.bin au PATH
        PATH = "${WORKSPACE}/Backend/node_modules/.bin:${env.PATH}"
    }

    stages {
        // Étape 1 : Installation des dépendances
        stage('Install Dependencies') {
            steps {
                dir('Backend') {
                    sh 'npm install'
                }
            }
        }

        // Étape 2 : Tests unitaires (simulés ici)
        stage('Unit Test') {
            steps {
                dir('Backend') {
                    script {
                        sh 'echo "No tests specified"'
                    }
                }
            }
        }

        // Étape 3 : Analyse SonarQube
        stage('SonarQube Analysis') {
            steps {
                script {
                    // Utiliser l'outil SonarQube Scanner configuré dans Jenkins
                    def scannerHome = tool 'scanner'
                    withSonarQubeEnv('scanner') { // Remplacez 'scanner' par le nom de votre configuration SonarQube dans Jenkins
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }

        // Étape 4 : Construction de l'application
        stage('Build Application') {
            steps {
                dir('Backend') {
                    script {
                        // Vérifier les permissions de webpack
                        sh 'ls -l node_modules/.bin/webpack || true' // Affiche les permissions (optionnel)
                        sh 'chmod +x node_modules/.bin/webpack'     // Donne les permissions d'exécution à webpack

                        // Exécuter la commande de build
                        sh 'npm run build'
                    }
                }
            }
        }
    }

    // Gestion des erreurs
    post {
        failure {
            echo 'Pipeline has failed. Check the logs for more details.'
        }
        success {
            echo 'Pipeline succeeded!'
        }
    }
}